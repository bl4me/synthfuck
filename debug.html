<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Finder Debug Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .debug-section h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .debug-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .debug-button:hover {
            background: #45a049;
        }

        .debug-button.danger {
            background: #f44336;
        }

        .debug-button.danger:hover {
            background: #da190b;
        }

        .debug-output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-good {
            background: #4CAF50;
        }

        .status-bad {
            background: #f44336;
        }

        .status-unknown {
            background: #FFC107;
        }

        .test-links {
            margin: 20px 0;
        }

        .test-link {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
        }

        .test-link.bandcamp {
            background: #fff5f0;
            border-left: 4px solid #FF6B35;
        }

        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .console-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Link Finder Extension Debug Page</h1>

    <div class="instructions">
        <h3>Debug Instructions:</h3>
        <ol>
            <li>Open Firefox Developer Tools (F12)</li>
            <li>Install the Link Finder extension</li>
            <li>Refresh this page</li>
            <li>Use the buttons below to test functionality</li>
            <li>Check the console for debug messages</li>
        </ol>
    </div>

    <div class="debug-section">
        <h2>Extension Status</h2>
        <div id="extensionStatus">
            <div><span class="status-indicator status-unknown"></span>Content Script: <span id="contentScriptStatus">Unknown</span></div>
            <div><span class="status-indicator status-unknown"></span>Link Finder: <span id="linkFinderStatus">Unknown</span></div>
            <div><span class="status-indicator status-unknown"></span>Message Passing: <span id="messageStatus">Unknown</span></div>
        </div>
        <button class="debug-button" onclick="checkExtensionStatus()">Check Extension Status</button>
        <button class="debug-button" onclick="clearDebugOutput()">Clear Output</button>
    </div>

    <div class="debug-section">
        <h2>Test Links</h2>
        <div class="test-links">
            <a href="https://agriculture.bandcamp.com/album/the-spiritual-sound" class="test-link bandcamp">
                <strong>The Spiritual Sound</strong>
                <span>by Agriculture (Bandcamp)</span>
            </a>
            <a href="https://testartist.bandcamp.com/track/sample-track" class="test-link bandcamp">
                <strong>Sample Track</strong>
                <span>by Test Artist (Bandcamp)</span>
            </a>
            <a href="https://example.com/regular-link" class="test-link">
                <strong>Regular Link</strong>
                <span>Example.com</span>
            </a>
            <a href="https://github.com/project" class="test-link">
                <strong>GitHub Project</strong>
                <span>GitHub.com</span>
            </a>
        </div>
        <button class="debug-button" onclick="addTestLink()">Add Test Link</button>
        <button class="debug-button" onclick="removeTestLink()">Remove Test Link</button>
    </div>

    <div class="debug-section">
        <h2>Manual Tests</h2>
        <button class="debug-button" onclick="testLinkDetection()">Test Link Detection</button>
        <button class="debug-button" onclick="testMessagePassing()">Test Message Passing</button>
        <button class="debug-button" onclick="testHighlighting()">Test Highlighting</button>
        <button class="debug-button" onclick="simulatePopupRequest()">Simulate Popup Request</button>
        <button class="debug-button danger" onclick="injectContentScript()">Force Inject Content Script</button>
    </div>

    <div class="debug-section">
        <h2>Debug Output</h2>
        <div id="debugOutput" class="debug-output">Click "Check Extension Status" to begin debugging...</div>
    </div>

    <div class="debug-section">
        <h2>Console Monitor</h2>
        <div id="consoleOutput" class="console-output">Console messages will appear here...</div>
        <button class="debug-button" onclick="startConsoleMonitor()">Start Console Monitor</button>
        <button class="debug-button" onclick="stopConsoleMonitor()">Stop Console Monitor</button>
    </div>

    <script>
        let testLinkCounter = 0;
        let consoleMonitorInterval;

        function log(message) {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
            console.log('[Debug Page]', message);
        }

        function updateStatus(elementId, status, isGood) {
            const element = document.getElementById(elementId);
            const indicator = element.previousElementSibling;
            element.textContent = status;
            indicator.className = `status-indicator ${isGood ? 'status-good' : 'status-bad'}`;
        }

        function clearDebugOutput() {
            document.getElementById('debugOutput').textContent = '';
            log('Debug output cleared');
        }

        function checkExtensionStatus() {
            log('Checking extension status...');

            // Check if content script is loaded
            if (typeof window.linkFinder !== 'undefined') {
                updateStatus('contentScriptStatus', 'Loaded', true);
                updateStatus('linkFinderStatus', 'Available', true);
                log('‚úì Content script is loaded');
                log('‚úì LinkFinder is available');

                // Test basic functionality
                try {
                    const links = window.linkFinder.getLinks();
                    log(`‚úì Found ${links.length} links`);
                    const bandcampLinks = window.linkFinder.getBandcampLinks();
                    log(`‚úì Found ${bandcampLinks.length} Bandcamp links`);
                } catch (error) {
                    log(`‚úó Error testing LinkFinder: ${error.message}`);
                }
            } else {
                updateStatus('contentScriptStatus', 'Not Loaded', false);
                updateStatus('linkFinderStatus', 'Not Available', false);
                log('‚úó Content script not loaded');
            }

            // Check if browser extension APIs are available
            if (typeof browser !== 'undefined' && browser.runtime) {
                log('‚úì Browser extension APIs available');
                updateStatus('messageStatus', 'Available', true);
            } else {
                log('‚úó Browser extension APIs not available');
                updateStatus('messageStatus', 'Not Available', false);
            }
        }

        function testLinkDetection() {
            log('Testing link detection...');

            if (typeof window.linkFinder === 'undefined') {
                log('‚úó LinkFinder not available');
                return;
            }

            try {
                window.linkFinder.scanForLinks();
                const links = window.linkFinder.getLinks();
                log(`‚úì Scan completed, found ${links.length} links`);

                links.forEach((link, index) => {
                    log(`  ${index + 1}. ${link.title} (${link.domain}) ${link.isBandcamp ? '[BANDCAMP]' : ''}`);
                });
            } catch (error) {
                log(`‚úó Error in link detection: ${error.message}`);
            }
        }

        function testMessagePassing() {
            log('Testing message passing...');

            if (typeof browser === 'undefined' || !browser.runtime) {
                log('‚úó Browser APIs not available');
                return;
            }

            // This won't work from content script context, but we can try
            log('Note: Message passing test should be done from popup context');
        }

        function testHighlighting() {
            log('Testing highlighting...');

            if (typeof window.linkFinder === 'undefined') {
                log('‚úó LinkFinder not available');
                return;
            }

            try {
                window.linkFinder.highlightLinks();
                log('‚úì Highlighting applied');
            } catch (error) {
                log(`‚úó Error in highlighting: ${error.message}`);
            }
        }

        function simulatePopupRequest() {
            log('Simulating popup request...');

            if (typeof window.linkFinder === 'undefined') {
                log('‚úó LinkFinder not available');
                return;
            }

            try {
                window.linkFinder.scanForLinks();
                const response = { links: window.linkFinder.getLinks() };
                log(`‚úì Simulated response: ${JSON.stringify(response, null, 2)}`);
            } catch (error) {
                log(`‚úó Error simulating popup request: ${error.message}`);
            }
        }

        function injectContentScript() {
            log('Attempting to inject content script...');

            // This should be done from background script context
            log('Note: Content script injection should be done from background script');

            // Try to create a new LinkFinder instance
            if (typeof LinkFinder !== 'undefined') {
                try {
                    window.linkFinder = new LinkFinder();
                    log('‚úì Created new LinkFinder instance');
                } catch (error) {
                    log(`‚úó Error creating LinkFinder: ${error.message}`);
                }
            } else {
                log('‚úó LinkFinder class not available');
            }
        }

        function addTestLink() {
            testLinkCounter++;
            const container = document.querySelector('.test-links');
            const link = document.createElement('a');
            link.href = `https://test${testLinkCounter}.bandcamp.com/album/test-album`;
            link.className = 'test-link bandcamp';
            link.innerHTML = `<strong>Test Album ${testLinkCounter}</strong><span>by Test Artist ${testLinkCounter} (Bandcamp)</span>`;
            container.appendChild(link);
            log(`Added test link: Test Album ${testLinkCounter}`);

            // Trigger rescan if LinkFinder is available
            if (typeof window.linkFinder !== 'undefined') {
                setTimeout(() => {
                    window.linkFinder.scanForLinks();
                    log('Triggered rescan after adding link');
                }, 100);
            }
        }

        function removeTestLink() {
            const container = document.querySelector('.test-links');
            const links = container.querySelectorAll('a');
            if (links.length > 4) { // Keep the original 4 links
                links[links.length - 1].remove();
                log('Removed last test link');

                // Trigger rescan if LinkFinder is available
                if (typeof window.linkFinder !== 'undefined') {
                    setTimeout(() => {
                        window.linkFinder.scanForLinks();
                        log('Triggered rescan after removing link');
                    }, 100);
                }
            } else {
                log('No test links to remove');
            }
        }

        function startConsoleMonitor() {
            if (consoleMonitorInterval) {
                return;
            }

            const consoleOutput = document.getElementById('consoleOutput');
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;

            function addToConsoleOutput(level, args) {
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                const message = `[${timestamp}] ${level}: ${Array.from(args).join(' ')}\n`;
                consoleOutput.textContent += message;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;

                // Keep only last 100 lines
                const lines = consoleOutput.textContent.split('\n');
                if (lines.length > 100) {
                    consoleOutput.textContent = lines.slice(-100).join('\n');
                }
            }

            console.log = function(...args) {
                addToConsoleOutput('LOG', args);
                originalLog.apply(console, args);
            };

            console.error = function(...args) {
                addToConsoleOutput('ERROR', args);
                originalError.apply(console, args);
            };

            console.warn = function(...args) {
                addToConsoleOutput('WARN', args);
                originalWarn.apply(console, args);
            };

            log('Console monitor started');
        }

        function stopConsoleMonitor() {
            if (consoleMonitorInterval) {
                clearInterval(consoleMonitorInterval);
                consoleMonitorInterval = null;
            }
            log('Console monitor stopped');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('Debug page loaded');
            setTimeout(checkExtensionStatus, 500);
        });

        // Check for content script every 2 seconds
        setInterval(function() {
            if (typeof window.linkFinder !== 'undefined') {
                const statusElement = document.getElementById('contentScriptStatus');
                if (statusElement.textContent !== 'Loaded') {
                    checkExtensionStatus();
                }
            }
        }, 2000);
    </script>
</body>
</html>
